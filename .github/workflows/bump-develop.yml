name: Bump Develop Version

on:
  repository_dispatch:
    types: [bump-develop]

jobs:
  bump:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
      
      - name: Calculate next version
        id: next
        run: |
          RELEASED="${{ github.event.client_payload.version }}"
          IFS='.' read -r major minor patch <<< "$RELEASED"
          NEXT="$major.$minor.$((patch + 1))-dev"
          echo "NEXT_VERSION=$NEXT" >> $GITHUB_OUTPUT
          echo "Next dev version: $NEXT"
      
      - name: Merge main into develop
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git merge origin/main --no-edit
      
      - name: Update version
        run: |
          sed -i "s/version = \".*\"/version = \"${{ steps.next.outputs.NEXT_VERSION }}\"/" Sources/VortexSDK/VortexSDK.swift
      
      - name: Create bump branch and PR
        run: |
          BRANCH="chore/bump-${{ steps.next.outputs.NEXT_VERSION }}"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "Bump version to ${{ steps.next.outputs.NEXT_VERSION }} for development"
          git push -u origin "$BRANCH"
      
      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base develop \
            --head "chore/bump-${{ steps.next.outputs.NEXT_VERSION }}" \
            --title "Bump version to ${{ steps.next.outputs.NEXT_VERSION }}" \
            --body "Automated version bump after release.

This PR:
- Merges main (with release) into develop
- Bumps version to \`${{ steps.next.outputs.NEXT_VERSION }}\` for continued development"
